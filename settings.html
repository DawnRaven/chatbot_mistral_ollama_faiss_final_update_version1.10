<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>C√†i ƒë·∫∑t Chatbot</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        button, input[type="radio"] {
            padding: 6px 12px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h2>Danh s√°ch m√¥ h√¨nh Ollama</h2>
    <table id="models-table">
        <thead>
            <tr>
                <th>Ch·ªçn</th>
                <th>T√™n m√¥ h√¨nh</th>
                <th>Th√¥ng s·ªë</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Thao t√°c</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h2>C·∫≠p nh·∫≠t FAISS Index</h2>
    <button onclick="reindex()">C·∫≠p nh·∫≠t l·∫°i FAISS Index</button>

    <h2>Tr·∫°ng th√°i m√¥ h√¨nh hi·ªán t·∫°i</h2>
    <div id="model-status" style="margin-top: 1rem; font-family: monospace; color: #333;"></div>

    <h2>Instruction h·ªá th·ªëng</h2>
    <textarea id="instruction" rows="5" style="width: 100%;"></textarea><br />
    <button onclick="updateInstruction()">C·∫≠p nh·∫≠t instruction</button>

    <div style="margin-top: 20px;">
        <h3>Nh·∫≠p t√™n model ƒë·ªÉ t·∫£i (Ollama)</h3>
        <input type="text" id="modelNameInput" placeholder="v√≠ d·ª•: mistral" style="width: 300px;" />
        <button onclick="pullModel()">T·∫£i model</button>
        <p id="pullStatus"></p>
    </div>

    <div style="margin-top: 30px;">
        <h3>Th√¥ng tin c√°c container Docker ƒëang ch·∫°y</h3>
        <button onclick="loadContainers()">L√†m m·ªõi</button>
        <table border="1" id="containerTable" style="margin-top: 10px;">
            <thead>
                <tr><th>ID</th><th>T√™n</th><th>IP</th><th>C·ªïng</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div style="margin-top: 30px;">
        <h3>ƒê·∫∑t ƒë·ªãa ch·ªâ Backend API</h3>
        <input type="text" id="backendHostInput" placeholder="v√≠ d·ª•: http://192.168.1.100:8000" style="width: 400px;" />
        <button onclick="saveBackendHost()">L∆∞u c·∫•u h√¨nh</button>
        <p id="backendStatus"></p>
    </div>

    <div style="margin-top: 30px;">
        <h3>Th√¥ng tin c·∫•u h√¨nh trong LocalStorage</h3>
        <button onclick="showLocalStorage()">Hi·ªÉn th·ªã c·∫•u h√¨nh</button>
        <button onclick="resetLocalStorage()" style="margin-left: 10px; color: red;">X√≥a to√†n b·ªô c·∫•u h√¨nh</button>
        <pre id="localStorageOutput" style="background:#f9f9f9;padding:10px;border:1px solid #ccc;margin-top:10px;"></pre>
    </div>

    <div style="margin-top: 30px;">
        <h3>K√©o model t·ª´ Ollama API (th·ªß c√¥ng)</h3>
        <input type="text" id="apiModelName" placeholder="v√≠ d·ª•: llama3, mistral" style="width: 300px;" />
        <button onclick="pullModelFromApi()">T·∫£i model t·ª´ API</button>
        <p id="apiPullStatus"></p>
    </div>

<script>
let BACKEND_HOST = localStorage.getItem("BACKEND_HOST") || "http://localhost:8000";
let currentModel = localStorage.getItem("chatbot_model") || "";

window.addEventListener("DOMContentLoaded", () => {
    document.getElementById("backendHostInput").value = BACKEND_HOST;
    fetchInstruction();
    fetchModelStatus();
    fetchModels();
    loadContainers();
});

function saveBackendHost() {
    const input = document.getElementById("backendHostInput").value;
    if (input) {
        localStorage.setItem("BACKEND_HOST", input);
        BACKEND_HOST = input;
        document.getElementById("backendStatus").innerText = "ƒê√£ l∆∞u ƒë·ªãa ch·ªâ backend.";
        loadContainers();
    }
}

async function fetchBackend(path, options = {}) {
    const url = BACKEND_HOST + path;
    return await fetch(url, options);
}

async function fetchModels() {
    const res = await fetchBackend("/models/list");
    const models = await res.json();
    const tableBody = document.querySelector("#models-table tbody");
    tableBody.innerHTML = "";

    models.forEach(model => {
        const isPulled = model.details && model.details.size;
        const modelName = model.name;
        const status = (modelName === currentModel) ? "ƒêang s·ª≠ d·ª•ng" : (isPulled ? "ƒê√£ t·∫£i" : "Ch∆∞a t·∫£i");
        const row = document.createElement("tr");
        row.innerHTML = `
            <td><input type="radio" name="currentModel" value="${modelName}" ${modelName === currentModel ? "checked" : ""} onchange="selectModel('${modelName}')"></td>
            <td>${modelName}</td>
            <td>${model.details?.parameter_size || "?"}</td>
            <td>${status}</td>
            <td><button onclick="pullModelFromList('${modelName}')">T·∫£i m√¥ h√¨nh</button></td>
        `;
        tableBody.appendChild(row);
    });
}

async function fetchInstruction() {
    try {
        const res = await fetchBackend("/get-instruction");
        const data = await res.json();
        document.getElementById("instruction").value = data.instruction || "";
    } catch (err) {
        console.error("Kh√¥ng th·ªÉ l·∫•y instruction:", err);
    }
}

async function updateInstruction() {
    const value = document.getElementById("instruction").value;
    const res = await fetchBackend("http://localhost:8000/set-instruction", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ instruction: value })
    });
    const data = await res.json();
    alert(data.message || "ƒê√£ c·∫≠p nh·∫≠t.");
}

function selectModel(name) {
    currentModel = name;
    localStorage.setItem("chatbot_model", name);
    fetchBackend("/set-model", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name })
    }).then(res => res.json()).then(data => {
        alert(data.message || "ƒê√£ g·ª≠i y√™u c·∫ßu ch·ªçn m√¥ h√¨nh.");
    });
}

async function pullModel() {
    const modelName = document.getElementById("modelNameInput").value;
    const statusEl = document.getElementById("pullStatus");
    if (!modelName) {
        statusEl.innerText = "Vui l√≤ng nh·∫≠p t√™n model.";
        return;
    }
    try {
        console.log(modelName);
        const response = await fetchBackend("http://localhost:8000/models/pull", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: modelName })
        });
        const data = await response.json();
        statusEl.innerText = data.message || "Model ƒë√£ ƒë∆∞·ª£c t·∫£i.";
        fetchModelStatus();
        fetchModels();
    } catch (error) {
        statusEl.innerText = "L·ªói khi t·∫£i model: " + error.message;
    }
}

async function pullModelFromList(modelName) {
    const response = await fetchBackend("http://localhost:8000/models/pull", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: modelName })
    });
    const data = await response.json();
    alert(data.message || "ƒê√£ g·ª≠i y√™u c·∫ßu t·∫£i m√¥ h√¨nh.");
    fetchModelStatus();
    fetchModels();
}

async function pullModelFromApi() {
    const model = document.getElementById("apiModelName").value;
    const status = document.getElementById("apiPullStatus");
    if (!model) {
        status.innerText = "Vui l√≤ng nh·∫≠p t√™n model.";
        return;
    }
    try {
        const response = await fetch(BACKEND_HOST + "/models/pull", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: model })
        });
        const data = await response.json();
        status.innerText = data.message || "ƒê√£ g·ª≠i y√™u c·∫ßu t·∫£i model.";
        fetchModelStatus();
        fetchModels();
    } catch (error) {
        status.innerText = "L·ªói khi g·ªçi API: " + error.message;
    }
}

async function fetchModelStatus() {
    try {
        const res = await fetchBackend("http://localhost:8000/model/status");
        const data = await res.json();
        const container = document.getElementById("model-status");
        container.innerHTML = `
            <p><strong>‚úÖ Backend ƒëang d√πng:</strong> ${data.backend_model}</p>
            <p><strong>üì¶ ƒê√£ t·∫£i trong Ollama:</strong> ${Array.isArray(data.ollama_models) ? data.ollama_models.join(", ") : data.ollama_models}</p>
        `;
    } catch (err) {
        document.getElementById("model-status").innerText = "‚ö†Ô∏è Kh√¥ng th·ªÉ l·∫•y tr·∫°ng th√°i m√¥ h√¨nh.";
    }
}

async function loadContainers() {
    const tableBody = document.getElementById("containerTable")?.querySelector("tbody");
    if (!tableBody) return;
    tableBody.innerHTML = "";

    try {
        const response = await fetchBackend("/docker/containers");
        const data = await response.json();
        if (Array.isArray(data.containers)) {
            data.containers.forEach(c => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${c.id}</td>
                    <td>${c.name}</td>
                    <td>${c.ip}</td>
                    <td>${c.ports}</td>
                `;
                tableBody.appendChild(row);
            });
        } else {
            const row = document.createElement("tr");
            row.innerHTML = `<td colspan="4">Kh√¥ng c√≥ container n√†o ƒë∆∞·ª£c tr·∫£ v·ªÅ.</td>`;
            tableBody.appendChild(row);
        }
    } catch (error) {
        const row = document.createElement("tr");
        row.innerHTML = `<td colspan="4">L·ªói khi l·∫•y th√¥ng tin: ${error.message}</td>`;
        tableBody.appendChild(row);
    }
}

function showLocalStorage() {
    let output = "";
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        const value = localStorage.getItem(key);
        output += `${key}: ${value}
`;
    }
    document.getElementById("localStorageOutput").innerText = output || "Kh√¥ng c√≥ c·∫•u h√¨nh n√†o.";
}

function resetLocalStorage() {
    if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô c·∫•u h√¨nh?")) {
        localStorage.clear();
        showLocalStorage();
        alert("ƒê√£ x√≥a to√†n b·ªô c·∫•u h√¨nh.");
    }
}
</script>

<h3>Ch·ªçn m√¥ h√¨nh Embedding</h3>
<label for="embedding">Ch·ªçn Embedding:</label>
<select id="embedding">
  <option value="distiluse-base-multilingual-cased-v2">distiluse-base-multilingual</option>
  <option value="intfloat/multilingual-e5-base">multilingual-e5-base</option>
  <option value="sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2">MiniLM-Multilingual</option>
</select>
<button onclick="updateEmbedding()">L∆∞u Embedding</button>

<script>
function updateEmbedding() {
  const embedding = document.getElementById('embedding').value;
  fetch('http://localhost:8000/config/embedding', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ embedding })
  }).then(res => res.ok ? alert("C·∫≠p nh·∫≠t th√†nh c√¥ng") : alert("L·ªói c·∫≠p nh·∫≠t embedding"));
}
</script>


<h3>Embedding hi·ªán t·∫°i</h3>
<p id="current-embedding">ƒêang t·∫£i...</p>

<script>
function fetchCurrentEmbedding() {
  fetch('http://localhost:8000/config/embedding/current')
    .then(response => response.json())
    .then(data => {
      document.getElementById('current-embedding').innerText = "ƒêang s·ª≠ d·ª•ng Embedding: " + (data.embedding || "Kh√¥ng x√°c ƒë·ªãnh");
    })
    .catch(error => {
      document.getElementById('current-embedding').innerText = "Kh√¥ng th·ªÉ l·∫•y tr·∫°ng th√°i embedding.";
    });
}
fetchCurrentEmbedding();
</script>


<h3>Ch·∫ø ƒë·ªô RAG Only</h3>
<label>
  <input type="checkbox" id="rag-only-toggle" onchange="toggleRagMode(this.checked)">
  B·∫≠t ch·∫ø ƒë·ªô ch·ªâ tr·∫£ l·ªùi theo t√†i li·ªáu (RAG Only)
</label>

<script>
function toggleRagMode(enabled) {
  fetch('http://localhost:8000/config/rag', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ enable: enabled })
  }).then(response => {
    if (response.ok) {
      alert(enabled ? "ƒê√£ b·∫≠t RAG Only" : "ƒê√£ t·∫Øt RAG Only");
    } else {
      alert("L·ªói c·∫≠p nh·∫≠t ch·∫ø ƒë·ªô RAG");
    }
  });
}
</script>


<script>
function fetchCurrentRagMode() {
  fetch('http://localhost:8000/config/rag/current')
    .then(response => response.json())
    .then(data => {
      document.getElementById('rag-only-toggle').checked = data.rag_only_mode;
    })
    .catch(error => {
      console.error('L·ªói l·∫•y tr·∫°ng th√°i RAG Only:', error);
    });
}
// G·ªçi ngay khi m·ªü trang
fetchCurrentRagMode();
</script>

</body>
</html>